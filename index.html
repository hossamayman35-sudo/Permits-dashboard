<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>License Dashboard</title>
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2921/2921226.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&family=IBM+Plex+Mono:wght@500;600&display=swap" rel="stylesheet">

    <style>
        /* --- Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª --- */
        :root {
            --primary-accent: #6366f1;
            --secondary-accent: #8b5cf6;
            --dark-text: #1e293b;
            --light-text: #64748b;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(125deg, #f3f4f6, #eef2ff, #e0e7ff, #ede9fe);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--dark-text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px) saturate(180%); border-bottom: 1px solid rgba(255, 255, 255, 0.5); }
        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(25px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            border-radius: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .glass-panel:hover { box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.12); }

        /* --- Table Headers (Sortable) --- */
        th.sortable { cursor: pointer; transition: background 0.2s, color 0.2s; user-select: none; }
        th.sortable:hover { background-color: rgba(99, 102, 241, 0.1); color: var(--primary-accent); }

        /* --- Table Styling --- */
        .full-width { width: 98%; margin: 0 auto; max-width: 1700px; }
        table { width: 100%; table-layout: fixed; border-collapse: separate; border-spacing: 0 6px; }
        
        th { font-weight: 800; color: var(--light-text); font-size: 0.75rem; padding: 16px 8px; background-color: rgba(248, 250, 252, 0.5); border-bottom: 1px solid rgba(226, 232, 240, 0.6); white-space: normal; vertical-align: middle; }
        
        /* Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙØ§Ù Ø§Ù„Ù†Øµ (Wrap Text) */
        td { 
            vertical-align: middle; background: rgba(255, 255, 255, 0.5); min-height: 60px; font-size: 0.8rem; 
            white-space: normal; word-wrap: break-word; padding: 8px 10px; transition: all 0.2s ease-in-out;
            border-top: 1px solid rgba(255, 255, 255, 0.3); border-bottom: 1px solid rgba(255, 255, 255, 0.3); 
            line-height: 1.4;
        }

        /* Hover Effect (Highlight Only) */
        tbody tr:hover {
            transform: scale(1.01);
            background-color: #ffffff !important;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
            z-index: 50; position: relative; border-radius: 8px;
        }
        tbody tr:hover td { background-color: #ffffff; border-color: transparent; }
        tbody tr:hover td:first-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }
        tbody tr:hover td:last-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }

        /* --- COLUMN WIDTHS (ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù„ÙÙˆÙ) --- */
        @media (min-width: 768px) {
            .w-check { width: 3%; text-align: center; }
            .w-id { width: 4.5%; font-weight: bold; color: #94a3b8; }
            .w-code { width: 9%; font-family: 'IBM Plex Mono', monospace; font-weight: 600; }
            .w-entity { width: 14%; font-weight: 700; }
            .w-type { width: 8%; }
            .w-desc { width: 16%; color: var(--light-text); }
            .w-loc { width: 4%; text-align: center; }
            .w-dur { width: 4%; text-align: center; }
            .w-date { width: 9.5%; font-family: 'IBM Plex Mono', monospace; direction: ltr; text-align: right; font-weight: 500; letter-spacing: -0.5px; }
            .w-stat-num { width: 5%; text-align: center; font-weight: bold; } 
            .w-stat-badge { width: 11%; text-align: center; } 
            .w-renew { width: 8%; text-align: center; font-weight: bold; }
            .w-act { width: 5%; text-align: center; }
        }

        /* --- BADGES --- */
        .status-badge { 
            padding: 6px 4px; border-radius: 8px; font-weight: 800; font-size: 0.7rem; color: white; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); white-space: nowrap; width: 100%; display: flex; justify-content: center; align-items: center;
        }
        .badge-active { background: linear-gradient(135deg, #34d399, #059669); }
        .badge-expired { background: linear-gradient(135deg, #fb7185, #e11d48); }
        .badge-warning { background: linear-gradient(135deg, #fbbf24, #d97706); }

        /* Renewal Colors */
        .renew-stopped { color: #be123c; background-color: #ffe4e6; padding: 6px 10px; border-radius: 8px; display: inline-block; width: 100%; }
        .renew-waiting { color: #b45309; background-color: #fef3c7; padding: 6px 10px; border-radius: 8px; display: inline-block; width: 100%; }
        .renew-renewed { color: #1d4ed8; background-color: #dbeafe; padding: 6px 10px; border-radius: 8px; display: inline-block; width: 100%; }
        .renew-active { color: #15803d; background-color: #dcfce7; padding: 6px 10px; border-radius: 8px; display: inline-block; width: 100%; }

        /* KPIs & Tooltips */
        .kpi-card { position: relative; overflow: visible; border-radius: 20px; transition: all 0.4s; border: 1px solid rgba(255,255,255,0.5); z-index: 1; }
        .kpi-card:hover { transform: translateY(-5px); z-index: 50; }
        .kpi-list { opacity: 0; visibility: hidden; position: absolute; top: 100%; left: 0; width: 100%; max-height: 220px; overflow-y: auto; background: rgba(255, 255, 255, 0.98); border: 1px solid rgba(226, 232, 240, 0.8); border-radius: 0 0 16px 16px; box-shadow: 0 20px 40px -5px rgba(0,0,0,0.15); transform: translateY(-10px); transition: all 0.3s; z-index: 100; }
        .kpi-card:hover .kpi-list { opacity: 1; visibility: visible; transform: translateY(5px); }
        .kpi-list-header { padding: 8px 12px; font-size: 0.7rem; font-weight: 800; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; position: sticky; top: 0; }
        .kpi-list-item { padding: 8px 12px; font-size: 0.75rem; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; transition: background 0.1s; }
        .kpi-list-item:hover { background: #f8fafc; color: var(--primary-accent); }
        
        .kpi-blue { background: linear-gradient(145deg, rgba(239,246,255,0.9), rgba(219,234,254,0.95)); color: #1e40af; }
        .kpi-green { background: linear-gradient(145deg, rgba(240,253,244,0.9), rgba(220,252,231,0.95)); color: #166534; }
        .kpi-amber { background: linear-gradient(145deg, rgba(255,251,235,0.9), rgba(254,243,199,0.95)); color: #92400e; }
        .kpi-rose { background: linear-gradient(145deg, rgba(255,241,242,0.9), rgba(255,228,230,0.95)); color: #9f1239; }

        /* Action Menu */
        .action-cell { overflow: visible !important; position: relative; z-index: 1; }
        .action-menu { display: none; position: absolute; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(25px); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 12px; box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.2); width: 140px; z-index: 9999 !important; top: 45px; left: 50%; transform: translateX(-50%); padding: 6px; }
        .action-menu.active { display: block; animation: menuPopup 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes menuPopup { from { opacity: 0; transform: translate(-50%, -10px) scale(0.9); } to { opacity: 1; transform: translate(-50%, 0) scale(1); } }
        .action-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; width: 100%; text-align: right; font-size: 0.75rem; font-weight: 700; color: var(--light-text); transition: all 0.2s; border-radius: 8px; cursor: pointer; }
        .action-item:hover { background-color: rgba(99, 102, 241, 0.1); color: var(--primary-accent); }
        .action-item.delete:hover { background-color: rgba(244, 63, 94, 0.1); color: var(--danger); }

        /* Toast */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 12px 24px; border-radius: 50px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.8); display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 0.8rem; animation: toastSlide 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: auto; min-width: 250px; justify-content: center; }
        .toast.success { color: var(--primary-accent); border-color: var(--primary-accent); }
        .toast.error { color: var(--danger); border-color: var(--danger); }
        @keyframes toastSlide { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Inputs & Others */
        .interactive-icon:hover { transform: scale(1.15); filter: drop-shadow(0 0 8px rgba(99, 102, 241, 0.4)); color: var(--primary-accent); }
        .btn-primary { background: linear-gradient(135deg, var(--primary-accent) 0%, var(--secondary-accent) 100%); color: white; box-shadow: 0 8px 20px -6px rgba(99, 102, 241, 0.5); transition: all 0.3s; border: 1px solid rgba(255,255,255,0.2); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 12px 25px -8px rgba(99, 102, 241, 0.6); }
        .input-field { transition: all 0.3s; border: 1px solid rgba(226, 232, 240, 0.8); background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }
        .input-field:focus { border-color: var(--primary-accent); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15); background: rgba(255, 255, 255, 0.9); outline: none; }
        
        /* 2. ØªØ¹Ø¯ÙŠÙ„ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ¨ÙŠØ± ÙˆØ§Ù„Ù…Ø¤Ø«Ø±Ø§Øª */
        #main-loader { 
            position: fixed; inset: 0; 
            background: rgba(243, 244, 246, 0.96); 
            backdrop-filter: blur(20px); 
            z-index: 9999; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            gap: 40px;
        }
        .spinner { width: 60px; height: 60px; border: 5px solid rgba(99, 102, 241, 0.2); border-top-color: var(--primary-accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ - ÙƒØ¨ÙŠØ± ÙˆÙØ§ÙŠØ¨Ø±Ù†Øª */
        .loader-text {
            font-weight: 900; 
            font-size: 3.5rem; /* Ø­Ø¬Ù… ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ */
            line-height: 1.4;
            text-align: center;
            max-width: 90%;
            
            /* ØªØ¯Ø±Ø¬ Ù„ÙˆÙ†ÙŠ Ù‚ÙˆÙŠ ÙˆØ²Ø¬Ø§Ø¬ÙŠ */
            background: linear-gradient(135deg, #4f46e5 0%, #d946ef 50%, #4f46e5 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            
            /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù„Ù…Ø¹Ø§Ù† ÙˆØ§Ù„Ø¸Ù„ */
            filter: drop-shadow(0 4px 10px rgba(99, 102, 241, 0.3));
            animation: shine 3s linear infinite;
        }

        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù„Ù…Ø¹Ø§Ù† Ù„Ù„Ù†Øµ */
        @keyframes shine {
            to { background-position: 200% center; }
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-enter { animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) { table { table-layout: auto; border-spacing: 0; } td { height: 50px; } .desktop-only { display: none; } .w-code { width: 25%; } .w-entity { width: 30%; font-weight: 700; } .w-desc { width: 30%; } .w-loc { width: 15%; } 
            .loader-text { font-size: 2rem; }
        }
        .iphone-scroll { -webkit-overflow-scrolling: touch; }
    </style>
</head>
<body class="text-xs" lang="ar">

    <div id="main-loader">
        <div class="spinner"></div>
        <div class="loader-text">Ù…Ø´Ø±ÙˆØ¹ ØªØµÙ…ÙŠÙ… ÙˆØªÙ†ÙÙŠØ° Ø®Ø·ÙŠ Ø·Ø±Ø¯ Ø§Ù„ÙØ§Ø¦Ø¶ Ø§Ù„Ø¨Ø­Ø±ÙŠ</div>
    </div>
    
    <div id="toast-container"></div>

    <header class="glass sticky top-0 z-40 w-full shadow-sm/50">
        <div class="full-width h-16 flex items-center justify-between px-4">
            <div class="flex items-center gap-3 animate-enter">
                <div class="bg-gradient-to-br from-indigo-500 to-violet-600 p-2.5 rounded-2xl shadow-lg shadow-indigo-500/30 interactive-icon">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 text-white"></i>
                </div>
                <div>
                    <h1 class="text-lg font-black text-slate-800 tracking-wide hidden md:block bg-clip-text text-transparent bg-gradient-to-r from-slate-800 to-indigo-800" data-i18n="appTitle">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h1>
                    <h1 class="text-base font-bold text-slate-800 md:hidden">Ø§Ù„Ø±Ø®Øµ</h1>
                </div>
            </div>
            <div class="flex items-center gap-3 animate-enter" style="animation-delay: 0.1s;">
                <button onclick="requestNotifyPermission()" class="p-2.5 bg-white/50 hover:bg-white/80 text-indigo-500 rounded-xl border border-indigo-100/50 shadow-sm transition-all active:scale-95 interactive-icon"><i data-lucide="bell" class="w-5 h-5"></i></button>
                <button onclick="toggleLanguage()" class="flex items-center gap-2 px-4 py-2 bg-white/50 hover:bg-white/80 text-slate-700 rounded-xl border border-slate-200/50 shadow-sm font-bold text-xs transition-all active:scale-95 interactive-icon">
                    <i data-lucide="globe" class="w-4 h-4"></i><span id="langLabel">EN</span>
                </button>
                <button onclick="exportToExcel()" class="hidden md:flex items-center gap-2 px-4 py-2 bg-emerald-50/80 hover:bg-emerald-100 text-emerald-600 rounded-xl border border-emerald-100 font-bold shadow-sm transition-all active:scale-95 interactive-icon" title="ØªØµØ¯ÙŠØ± Ù„Ù„Ø¥ÙƒØ³Ù„">
                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i><span class="hidden lg:inline">Excel</span>
                </button>
                <button id="bulkDeleteBtn" onclick="deleteSelected()" class="hidden flex items-center gap-2 px-4 py-2 bg-rose-50/80 hover:bg-rose-100 text-rose-600 rounded-xl border border-rose-100 font-bold shadow-sm transition-all active:scale-95 interactive-icon">
                    <i data-lucide="trash-2" class="w-4 h-4"></i><span class="hidden md:inline" data-i18n="btnDeleteSelected">Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯</span>
                </button>
                <button onclick="openModal()" class="flex items-center gap-2 px-5 py-2.5 btn-primary rounded-xl font-bold shadow-lg shadow-indigo-500/20 transition-all active:scale-95">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i><span class="hidden md:inline" data-i18n="btnAddLicense">Ø¥Ø¶Ø§ÙØ© Ø±Ø®ØµØ©</span>
                </button>
            </div>
        </div>
    </header>

    <main class="full-width py-8 space-y-8">
        <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-5" id="kpi-container"></div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-enter" style="animation-delay: 0.3s;">
            <div class="lg:col-span-2 glass-panel p-6 h-80 flex flex-col relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-500/5 rounded-full blur-3xl -z-10"></div>
                <div class="flex justify-between items-center mb-5">
                    <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2">
                        <div class="p-1.5 bg-indigo-100/50 rounded-lg"><i data-lucide="bar-chart-3" class="w-4 h-4 text-indigo-600"></i></div>
                        <span data-i18n="chartEntity">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¬Ù‡Ø§Øª</span>
                    </h3>
                </div>
                <div class="relative flex-1 w-full"><canvas id="entityChart"></canvas></div>
            </div>
            
            <div class="glass-panel p-6 h-80 flex flex-col relative overflow-hidden">
                <div class="absolute bottom-0 left-0 w-32 h-32 bg-emerald-500/5 rounded-full blur-3xl -z-10"></div>
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2">
                        <div class="p-1.5 bg-emerald-100/50 rounded-lg"><i data-lucide="pie-chart" class="w-4 h-4 text-emerald-600"></i></div>
                        <span data-i18n="chartStatus">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</span>
                    </h3>
                </div>
                <div class="relative flex-1 w-full flex justify-center items-center"><canvas id="statusChart" style="max-height: 220px;"></canvas></div>
            </div>
        </div>

        <div class="glass-panel overflow-hidden animate-enter" style="animation-delay: 0.4s;">
            <div class="p-5 border-b border-slate-100/50 flex flex-col md:flex-row justify-between items-center bg-white/30 gap-4">
                <h3 class="text-base font-bold text-slate-800 flex items-center gap-3">
                    <div class="p-2 bg-slate-200/50 rounded-xl shadow-inner"><i data-lucide="list-filter" class="w-5 h-5 text-slate-600"></i></div>
                    <span data-i18n="tableTitle">Ø³Ø¬Ù„ Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</span>
                </h3>
                <div class="flex gap-3 w-full md:w-auto">
                    <div class="relative w-full md:w-64 group">
                        <i data-lucide="search" class="absolute top-2.5 right-3 w-4 h-4 text-slate-400 group-hover:text-indigo-500 transition-colors ltr:right-auto ltr:left-3"></i>
                        <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„..." class="input-field pl-4 pr-10 py-2.5 rounded-xl text-xs w-full ltr:pl-10 ltr:pr-4 font-medium">
                    </div>
                    <select id="statusFilter" class="input-field px-4 py-2.5 rounded-xl text-xs bg-white/80 cursor-pointer min-w-[120px] font-bold text-slate-600">
                        <option value="all" data-i18n="filterAll">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</option>
                        <option value="active" data-i18n="filterActive">ğŸŸ¢ Ø³Ø§Ø±ÙŠØ©</option>
                        <option value="warning" data-i18n="filterWarning">ğŸŸ¡ ØªØ­Ø°ÙŠØ±</option>
                        <option value="expired" data-i18n="filterExpired">ğŸ”´ Ù…Ù†ØªÙ‡ÙŠØ©</option>
                    </select>
                </div>
            </div>
            
            <div class="w-full overflow-x-auto min-h-[400px] iphone-scroll p-2">
                <table class="text-right text-xs ltr:text-left w-full" id="licensesTable">
                    <thead>
                        <tr>
                            <th class="w-check text-center desktop-only rounded-r-xl"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="custom-checkbox scale-110"></th>
                            <th class="w-id desktop-only sortable" data-i18n="thID" onclick="sortTable(1)">Ø§Ù„Ø±Ù‚Ù… â†•</th>
                            <th class="w-code" data-i18n="thCode">Ø§Ù„ÙƒÙˆØ¯</th>
                            <th class="w-entity sortable" data-i18n="thEntity" onclick="sortTable(3)">Ø§Ù„Ø¬Ù‡Ø© â†•</th>
                            <th class="w-type desktop-only" data-i18n="thType">Ø§Ù„Ù†ÙˆØ¹</th>
                            <th class="w-desc" data-i18n="thDesc">Ø§Ù„ÙˆØµÙ</th>
                            <th class="w-loc text-center" data-i18n="thLocation">Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                            <th class="w-dur text-center desktop-only" data-i18n="thDuration">Ø§Ù„Ù…Ø¯Ø©</th>
                            <th class="w-date desktop-only sortable" data-i18n="thStart" onclick="sortTable(8)">Ø§Ù„Ø¨Ø¯Ø¡ â†•</th>
                            <th class="w-date desktop-only sortable" data-i18n="thEnd" onclick="sortTable(9)">Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ â†•</th>
                            <th class="w-stat-num text-center desktop-only sortable" data-i18n="thRemaining" onclick="sortTable(10)">Ù…ØªØ¨Ù‚ÙŠ â†•</th>
                            <th class="w-stat-badge text-center desktop-only" data-i18n="thStatus">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th class="w-renew text-center desktop-only" data-i18n="thRenewal">ØªØ¬Ø¯ÙŠØ¯</th>
                            <th class="w-act text-center rounded-l-xl" data-i18n="thActions">Ø¥Ø¬Ø±Ø§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100/50 bg-white/10 space-y-2"></tbody>
                </table>
            </div>
            <div class="px-6 py-4 border-t border-slate-100/50 text-[11px] text-slate-500 font-medium flex justify-between items-center bg-slate-50/30" id="tableFooter"></div>
        </div>
    </main>

    <div id="licenseModal" class="relative z-50 hidden">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-md transition-opacity" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div class="relative transform overflow-hidden rounded-3xl glass-panel text-right shadow-2xl transition-all w-full max-w-lg border-0 ltr:text-left animate-enter">
                    <div class="bg-white/50 px-6 py-4 border-b border-slate-100/50 flex justify-between items-center">
                        <h3 class="text-lg font-black text-slate-800 bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-violet-600" id="modalTitle" data-i18n="modalAdd">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø®ØµØ©</h3>
                        <button onclick="closeModal()" class="text-slate-400 hover:text-rose-500 p-1.5 bg-white/60 rounded-full border border-slate-200/50 shadow-sm transition-all hover:rotate-90"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    <form id="licenseForm" class="p-6 space-y-5 bg-white/20">
                        <input type="hidden" id="editIndex">
                        <input type="hidden" id="existingFileUrl">
                        <div class="bg-indigo-50/40 p-4 rounded-2xl border-2 border-indigo-200/50 border-dashed text-center group hover:bg-indigo-50/70 transition-colors cursor-pointer">
                            <div class="mb-2 text-indigo-500 group-hover:scale-110 transition-transform"><i data-lucide="upload-cloud" class="w-8 h-8 mx-auto"></i></div>
                            <label class="block text-xs font-bold text-indigo-700 mb-2 cursor-pointer">Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø±ÙØ¹ (PDF/ØµÙˆØ±Ø©)</label>
                            <input type="file" id="inputFile" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200 cursor-pointer mx-auto">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-[11px] font-bold text-slate-600 mb-1.5">Ø§Ù„Ø±Ù‚Ù…</label><input type="text" id="inputNumber" required class="input-field w-full p-2.5 rounded-xl text-xs font-bold"></div>
                            <div><label class="block text-[11px] font-bold text-slate-600 mb-1.5">Ø§Ù„ÙƒÙˆØ¯</label><input type="text" id="inputCode" required class="input-field w-full p-2.5 rounded-xl text-xs dir-ltr font-mono font-black tracking-wider"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[11px] font-bold text-slate-600 mb-1.5">Ø§Ù„Ø¬Ù‡Ø©</label>
                                <select id="inputEntity" onchange="handleNewInput(this, 'newEntityDiv')" class="input-field w-full p-2.5 rounded-xl text-xs font-medium cursor-pointer"><option value="">-- Ø§Ø®ØªØ± --</option><option value="ADD_NEW" class="font-bold text-indigo-600">+ Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</option></select>
                                <div id="newEntityDiv" class="hidden mt-2 animate-enter"><input type="text" id="newEntityInput" class="input-field w-full p-2.5 rounded-xl text-xs" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯"></div>
                            </div>
                            <div>
                                <label class="block text-[11px] font-bold text-slate-600 mb-1.5">Ø§Ù„Ù†ÙˆØ¹</label>
                                <select id="inputType" onchange="handleNewInput(this, 'newTypeDiv')" class="input-field w-full p-2.5 rounded-xl text-xs font-medium cursor-pointer"><option value="">-- Ø§Ø®ØªØ± --</option><option value="ADD_NEW" class="font-bold text-indigo-600">+ Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯</option></select>
                                <div id="newTypeDiv" class="hidden mt-2 animate-enter"><input type="text" id="newTypeInput" class="input-field w-full p-2.5 rounded-xl text-xs" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†ÙˆØ¹..."></div>
                            </div>
                        </div>
                        <div><label class="block text-[11px] font-bold text-slate-600 mb-1.5">Ø§Ù„ÙˆØµÙ / Ø§Ù„Ø´Ø§Ø±Ø¹</label><input type="text" id="inputDesc" class="input-field w-full p-2.5 rounded-xl text-xs"></div>
                        <div class="bg-amber-50/50 p-3 rounded-xl border border-amber-200/50 flex items-center gap-3">
                            <div class="p-2 bg-white/80 rounded-lg shadow-sm text-amber-500"><i data-lucide="bell-ring" class="w-5 h-5"></i></div>
                            <div class="flex-1">
                                <label class="block text-[11px] font-bold text-amber-800 mb-1">Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</label>
                                <select id="inputRenewal" class="input-field w-full p-2 rounded-lg text-xs border-amber-200 text-amber-900 font-bold cursor-pointer">
                                    <option value="ØªÙØ¹ÙŠÙ„">ğŸ”” ØªÙØ¹ÙŠÙ„ (ØªÙ†Ø¨ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠ)</option>
                                    <option value="ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯">âœ… ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ (Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡)</option>
                                    <option value="Ø¥ÙŠÙ‚Ø§Ù">ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù</option>
                                </select>
                            </div>
                        </div>
                        <div><label class="block text-[11px] font-bold text-slate-600 mb-1.5">Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ (GPS)</label><input type="url" id="inputLocation" class="input-field w-full p-2.5 rounded-xl text-xs dir-ltr text-blue-600 underline font-medium" placeholder="https://maps.google.com/..."></div>
                        <div class="grid grid-cols-3 gap-3">
                            <div><label class="block text-[11px] font-bold text-slate-600 mb-1.5">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</label><input type="date" id="inputStart" onchange="calcDuration()" class="input-field w-full p-2.5 rounded-xl text-xs font-medium cursor-pointer"></div>
                            <div><label class="block text-[11px] font-bold text-slate-600 mb-1.5">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label><input type="date" id="inputEnd" onchange="calcDuration()" class="input-field w-full p-2.5 rounded-xl text-xs font-medium cursor-pointer"></div>
                            <div><label class="block text-[11px] font-bold text-slate-400 mb-1.5">Ø§Ù„Ù…Ø¯Ø© (ÙŠÙˆÙ…)</label><input type="number" id="inputDuration" readonly class="input-field w-full p-2.5 rounded-xl text-xs bg-slate-100/80 text-center font-black text-slate-600"></div>
                        </div>
                        <div><label class="block text-[11px] font-bold text-slate-600 mb-1.5">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label><textarea id="inputNotes" rows="3" class="input-field w-full p-2.5 rounded-xl text-xs"></textarea></div>
                    </form>
                    <div class="bg-white/60 px-6 py-4 flex flex-row-reverse gap-3 border-t border-slate-100/50">
                        <button onclick="saveLicense()" id="saveBtn" class="inline-flex justify-center items-center gap-2 rounded-xl btn-primary px-6 py-2.5 text-xs font-bold shadow-lg shadow-indigo-500/20 transition-all active:scale-95">
                            <i data-lucide="save" class="w-4 h-4"></i> Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        </button>
                        <button onclick="closeModal()" class="inline-flex justify-center rounded-xl bg-white/80 px-5 py-2.5 text-xs font-bold text-slate-600 shadow-sm border border-slate-200/50 hover:bg-white transition-all active:scale-95">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzZVmx1BGq8WAlq26fYTK4umT-cglfoclNziruXbObKA4hO4BEuEvdRTp_KAOggoo2Kqg/exec';
        
        let licenseData = [];
        let selectedIds = new Set();
        let currentLang = 'ar';
        let entityChartInstance = null;
        let statusChartInstance = null;

        const uiTranslations = {
            ar: { appTitle: "Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©", btnDeleteSelected: "Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯", btnAddLicense: "Ø¥Ø¶Ø§ÙØ© Ø±Ø®ØµØ©", loading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...", chartEntity: "ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¬Ù‡Ø§Øª", chartStatus: "Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©", tableTitle: "Ø³Ø¬Ù„ Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ", filterAll: "Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„", filterActive: "ğŸŸ¢ Ø³Ø§Ø±ÙŠØ©", filterWarning: "ğŸŸ¡ ØªØ­Ø°ÙŠØ±", filterExpired: "ğŸ”´ Ù…Ù†ØªÙ‡ÙŠØ©", thID: "Ø§Ù„Ø±Ù‚Ù…", thCode: "Ø§Ù„ÙƒÙˆØ¯", thEntity: "Ø§Ù„Ø¬Ù‡Ø©", thType: "Ø§Ù„Ù†ÙˆØ¹", thDesc: "Ø§Ù„ÙˆØµÙ", thLocation: "Ù…ÙˆÙ‚Ø¹", thDuration: "Ù…Ø¯Ø©", thStart: "Ø§Ù„Ø¨Ø¯Ø¡", thEnd: "Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", thRemaining: "Ù…ØªØ¨Ù‚ÙŠ", thStatus: "Ø§Ù„Ø­Ø§Ù„Ø©", thRenewal: "ØªØ¬Ø¯ÙŠØ¯", thNotes: "Ù…Ù„Ø§Ø­Ø¸Ø§Øª", thActions: "Ø¥Ø¬Ø±Ø§Ø¡", modalAdd: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø®ØµØ©", modalEdit: "ØªØ¹Ø¯ÙŠÙ„", btnSave: "Ø­ÙØ¸", btnCancel: "Ø¥Ù„ØºØ§Ø¡", day: "ÙŠÙˆÙ…", kpiTotal: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø®Øµ", kpiActive: "Ø±Ø®Øµ Ø³Ø§Ø±ÙŠØ©", kpiWarning: "ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù†ØªÙ‡Ø§Ø¡", kpiExpired: "Ø±Ø®Øµ Ù…Ù†ØªÙ‡ÙŠØ©", menuEdit: "ØªØ¹Ø¯ÙŠÙ„", menuDup: "Ù†Ø³Ø®", menuDel: "Ø­Ø°Ù" },
            en: { appTitle: "Dashboard", btnDeleteSelected: "Delete Selected", btnAddLicense: "Add License", loading: "Loading...", chartEntity: "Entities Dist.", chartStatus: "Status Overview", tableTitle: "License Registry", filterAll: "Show All", filterActive: "ğŸŸ¢ Active", filterWarning: "ğŸŸ¡ Warning", filterExpired: "ğŸ”´ Expired", thID: "ID", thCode: "Code", thEntity: "Entity", thType: "Type", thDesc: "Description", thLocation: "Loc", thDuration: "Dur", thStart: "Start", thEnd: "End", thRemaining: "Left", thStatus: "Status", thRenewal: "Renew", thNotes: "Notes", thActions: "Actions", modalAdd: "License Details", modalEdit: "Edit", btnSave: "Save", btnCancel: "Cancel", day: "d", kpiTotal: "Total Licenses", kpiActive: "Active", kpiWarning: "Expiring Soon", kpiExpired: "Expired", menuEdit: "Edit", menuDup: "Duplicate", menuDel: "Delete" }
        };

        const techDict = { 
            "Ø­ÙŠ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ© - Ø­ÙŠ Ø§Ù„Ù†Ø§Ø¨ÙŠØ©": "Nabyia District - Industrial District",
            "Ø­ÙŠ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©": "Industrial District",
            "Ø­ÙŠ Ø§Ù„Ù†Ø§Ø¨ÙŠØ©": "Nabyia District",
            "ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø­Ø±Ø³ Ø§Ù„ÙˆØ·Ù†ÙŠ": "Ministry of National Guard", "Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„ØªØ­Ù„ÙŠØ© Ø§Ù„Ù…ÙŠØ§Ù‡ Ø§Ù„Ù…Ø§Ù„Ø­Ø©": "Saline Water Conversion Corporation", "Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ù„Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡": "Saudi Electricity Company", "Ø´Ø±ÙƒØ© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡": "Saudi Electricity Company", "Ø¨Ù„Ø¯ÙŠØ© Ø§Ù„Ù‚Ø·ÙŠÙ": "Qatif Municipality", "Ø¨Ù„Ø¯ÙŠØ© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡": "Al , Bayda Municipality", "Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø±ÙŠ": "Public Irrigation Corporation", "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ÙŠØ© Ø¨Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„Ù‚Ø·ÙŠÙ": "Traffic Safety Department in Qatif Governorate", "Ø£Ø¹Ù…Ø§Ù„ Ø­ÙØ±": "Excavation Works", "Ø«Ù‚Ø¨ Ø§ÙÙ‚ÙŠ": "Micro Tunnel", "Ø«Ù‚Ø¨ Ø£ÙÙ‚ÙŠ": "Micro Tunnel", "Ù†Ø²Ø­ Ù…ÙŠØ§Ù‡ Ø¬ÙˆÙÙŠØ©": "Underground Water Dewatering", "Ù†Ø²Ø­ Ù…ÙŠØ§Ù‡": "Underground Water Dewatering", "Ù†Ø²Ø­ Ø§Ù„Ù…ÙŠØ§Ù‡": "Underground Water Dewatering", "ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø³Ø§Ø±": "Full Track", "Ø·Ø±ÙŠÙ‚ Ø£Ø¨Ùˆ Ø­Ø¯Ø±ÙŠØ© Ø§Ù„ÙØ±Ø¹ÙŠ": "Abu Hadriya Branch Road", "Ø·Ø±ÙŠÙ‚ Ø³ÙŠØ¯Ù†Ø§ Ø¹Ù…Ø± Ø¨Ù† Ø§Ù„Ø®Ø·Ø§Ø¨": "The road of our master Omar bin Al-Khattab", "ØºØ±ÙØ© Ø§Ù„ØºØ³ÙŠÙ„": "Washout Chamber", "Laundry room": "Washout Chamber", "Ø¨Ø¹Ø¯ Ø§Ù„Ø«Ù‚Ø¨ Ø§Ù„Ø§ÙÙ‚ÙŠ": "After the Horizontal Hole", "Ø§Ø¨Ùˆ Ø§Ù„Ø®ÙŠØ± Ø§Ù„Ø³Ø®Ø§ÙˆÙŠ": "Abu Al-Khair Al-Sakhawi", "Ø§Ø¨Ùˆ Ø§Ù„ÙØ¶Ù„ Ø§Ù„Ø¨ÙŠÙ‡Ù‚ÙŠ": "Abu Al-Fadl Al-Bayhaqi", "Ø´Ø§Ø±Ø¹ Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ø¨Ù† Ø§Ù„Ø£Ø±Ù‚Ù…": "Abdul Rahman Bin Al-Arqam Street", "Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ø¨Ù† Ø§Ù„Ø£Ø±Ù‚Ù…": "Abd Alrahman Ibn Al Arqam", "Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±": "Hydro Test", "Ø´Ø§Ø±Ø¹ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©": "Industrial Street", "Ø·Ø±ÙŠÙ‚ Ø§Ù„Ù…Ù„Ùƒ Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ²": "King Abdulaziz Road", "Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙˆØ§Ø±": "After the Roundabout", "Ø´Ø§Ø±Ø¹ Ø¹Ø¨Ø§Ø¯Ø© Ø¨Ù† Ø§Ù„ØµØ§Ù…Øª": "Ubadah Bin Al-Samit Street", "Ø´Ø§Ø±Ø¹ Ø®Ø¨ÙŠØ¨ Ø¨Ù† Ø¹Ø¯ÙŠ": "Khubaib Bin Uday Street", "Ø¬Ù†Ø§Ø¯Ø© Ø§Ù„Ø§Ø²Ø¯ÙŠ": "Janada Al-Azdi", "Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù…Ù„Ø¹Ø¨": "In front of the stadium", "Ø­Ø¯ÙŠÙ‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†": "Zoo", "Ø§Ù„Ù†Ø³ÙŠÙ…": "Naseem", "Ø§Ù„Ø·Ù": "Latif", "Ø·Ø±ÙŠÙ‚ Ø§Ù„Ù…Ø²Ø§Ø±Ø¹": "Al Mazaree Road", "Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø¸Ù‡Ø±Ø§Ù† Ø§Ù„Ø¬Ø¨ÙŠÙ„": "Dhahran Jubail Road", "Ø¨Ø¬ÙˆØ§Ø±": "Next to", "ØªØµØ±ÙŠÙ Ù…ÙŠØ§Ù‡ Ø§Ù„Ø§Ù…Ø·Ø§Ø±": "Rainwater Drainage", "Ø´Ø§Ø±Ø¹ Ø§Ù„ØºØ¯ÙŠØ±": "Al Ghadeer Street", "Ø§Ù„ÙƒÙˆØ±Ù†ÙŠØ´": "Corniche", "Ø§Ù„Ù†Ø§Ø¨ÙŠØ©": "Nabyia", "Ø§Ù„Ø£ÙƒÙˆØ§Ø¹": "Elbows", "Ø´Ø§Ø±Ø¹": "Street", "Ø¥ÙŠÙ‚Ø§Ù": "Stopped", "ØªÙØ¹ÙŠÙ„": "Active", "Ù…Ù†ØªØ¸Ø±": "Waiting", "ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯": "Renewed", "Ø­ÙŠ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ© - Ø­ÙŠ Ø§Ù„Ù†Ø§Ø¨ÙŠØ©": "Nabyia District - Industrial District" 
        };

        function translateText(text) {
            if (currentLang === 'ar' || !text) return text;
            let val = String(text).trim();
            if (techDict[val]) return techDict[val];
            for (let key in techDict) { if (val.includes(key)) val = val.replace(new RegExp(key, "g"), techDict[key]); }
            return val;
        }

        async function fetchLicenses() {
            try {
                const res = await fetch(`${APPS_SCRIPT_URL}?v=${Date.now()}`);
                if (!res.ok) throw new Error("HTTP error " + res.status);
                licenseData = await res.json();
                document.getElementById('main-loader').style.display = 'none';
                populateDropdowns();
                renderAll();
                checkDesktopNotifications();
            } catch (e) { 
                document.getElementById('tableBody').innerHTML = `<tr><td colspan="15" class="text-center py-8 text-rose-500 font-bold dir-ltr">${e.message}</td></tr>`; 
                document.getElementById('main-loader').style.display = 'none';
            }
        }

        function parseDateSafe(dateInput) {
            if (!dateInput) return null;
            if (dateInput instanceof Date) return dateInput;
            let s = String(dateInput);
            if(s.includes('T')) {
                let d = new Date(s);
                d.setHours(d.getHours() + 12);
                return d;
            }
            let parts = s.split(/[-/]/);
            if (parts.length === 3) {
                 if (parts[0].length === 4) return new Date(parts[0], parts[1]-1, parts[2], 12, 0, 0);
            }
            return new Date(s);
        }

        function formatDisplayDate(dateStr) { 
            const date = parseDateSafe(dateStr);
            if (!date || isNaN(date.getTime())) return "-";
            const day = String(date.getDate()).padStart(2, '0');
            const month = date.toLocaleString('en-US', { month: 'short' }).toUpperCase();
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        }
        
        function toInputDate(d) {
            if(!d || isNaN(d.getTime())) return "";
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = type === 'success' ? `<i data-lucide="check-circle" class="w-5 h-5"></i>` : `<i data-lucide="alert-triangle" class="w-5 h-5"></i>`;
            toast.innerHTML += `<span>${message}</span>`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateY(-20px)'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function sortTable(n) {
            const table = document.getElementById("licensesTable");
            let rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
            switching = true; dir = "asc"; 
            while (switching) {
                switching = false; rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("TD")[n];
                    y = rows[i + 1].getElementsByTagName("TD")[n];
                    if (dir == "asc") { if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) { shouldSwitch = true; break; } } 
                    else if (dir == "desc") { if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) { shouldSwitch = true; break; } }
                }
                if (shouldSwitch) { rows[i].parentNode.insertBefore(rows[i + 1], rows[i]); switching = true; switchcount++; } 
                else { if (switchcount == 0 && dir == "asc") { dir = "desc"; switching = true; } }
            }
        }

        function exportToExcel() {
            const table = document.getElementById("licensesTable");
            const wb = XLSX.utils.table_to_book(table, {sheet: "Licenses"});
            XLSX.writeFile(wb, "Licenses_Data.xlsx");
        }

        function toggleMenu(id) {
            document.querySelectorAll('.action-menu').forEach(menu => {
                if (menu.id !== `menu-${id}`) menu.classList.remove('active');
            });
            const menu = document.getElementById(`menu-${id}`);
            if (menu) menu.classList.toggle('active');
        }

        window.onclick = function(event) {
            if (!event.target.closest('.action-cell')) {
                document.querySelectorAll('.action-menu').forEach(menu => menu.classList.remove('active'));
            }
        }

        function getRenewalClass(status) {
            if (status === 'ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯' || status === 'Renewed') return 'renew-renewed';
            if (status === 'Ø¥ÙŠÙ‚Ø§Ù' || status === 'Stopped') return 'renew-stopped';
            if (status === 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ¬Ø¯ÙŠØ¯' || status === 'Waiting Renewal') return 'renew-waiting';
            return 'renew-active';
        }

        function renderAll() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filter = document.getElementById('statusFilter').value;
            const tbody = document.getElementById('tableBody');
            
            const today = new Date();
            today.setHours(0,0,0,0);

            const processed = licenseData.map(item => {
                const endDate = parseDateSafe(item['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡']);
                let diff = 0;
                let status = "Ø³Ø§Ø±ÙŠØ©";
                
                if (endDate) {
                    const endD = new Date(endDate);
                    endD.setHours(0,0,0,0);
                    diff = Math.round((endD - today) / 86400000);
                    status = diff < 0 ? "Ù…Ù†ØªÙ‡ÙŠØ©" : diff <= 14 ? "Ø´Ø§Ø±ÙØª Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" : "Ø³Ø§Ø±ÙŠØ©";
                } else { status = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"; }
                
                return { ...item, diff, status };
            });

            const filtered = processed.filter(item => {
                const searchStr = `${item['Ø§Ù„Ø±Ù‚Ù…']} ${item['Ø§Ù„ÙƒÙˆØ¯']} ${item['Ø§Ù„Ø¬Ù‡Ø©']} ${item['Ù†ÙˆØ¹ Ø§Ù„Ø±Ø®ØµØ©']} ${item.desc_ar}`.toLowerCase();
                const statusCode = item.status === 'Ù…Ù†ØªÙ‡ÙŠØ©' ? 'expired' : item.status === 'Ø´Ø§Ø±ÙØª Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡' ? 'warning' : 'active';
                return searchStr.includes(search) && (filter === 'all' || statusCode === filter);
            });

            renderKPIs(processed); 
            
            tbody.innerHTML = filtered.map((row, index) => {
                const entity = translateText(currentLang === 'en' ? (row.entity_en || row['Ø§Ù„Ø¬Ù‡Ø©']) : row['Ø§Ù„Ø¬Ù‡Ø©']);
                const type = translateText(currentLang === 'en' ? (row.type_en || row['Ù†ÙˆØ¹ Ø§Ù„Ø±Ø®ØµØ©']) : row['Ù†ÙˆØ¹ Ø§Ù„Ø±Ø®ØµØ©']);
                const desc = translateText(currentLang === 'en' ? (row.desc_en || row.desc_ar) : row.desc_ar);
                const notes = translateText(currentLang === 'en' ? (row.notes_en || row['Ù…Ù„Ø§Ø­Ø¸Ø§Øª']) : row['Ù…Ù„Ø§Ø­Ø¸Ø§Øª']);
                
                let statusTxt = currentLang === 'en' ? (row.diff < 0 ? "Expired" : row.diff <= 14 ? "Warning" : "Active") : row.status;
                
                let dbRenewal = row['renewal_status'];
                let renewalDisplay;
                
                if (dbRenewal === "Ø¥ÙŠÙ‚Ø§Ù" || dbRenewal === "Stopped") {
                    renewalDisplay = currentLang === 'en' ? "Stopped" : "Ø¥ÙŠÙ‚Ø§Ù";
                } else if (dbRenewal === "ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯" || dbRenewal === "Renewed") {
                    renewalDisplay = currentLang === 'en' ? "Renewed" : "ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯";
                } else {
                    if (row.diff < 0) {
                        renewalDisplay = currentLang === 'en' ? "Stopped" : "Ø¥ÙŠÙ‚Ø§Ù";
                    } else if (row.diff <= 14) {
                        renewalDisplay = currentLang === 'en' ? "Waiting Renewal" : "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ¬Ø¯ÙŠØ¯";
                    } else {
                        renewalDisplay = currentLang === 'en' ? "Renewed" : "ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯";
                    }
                }
                
                const renewalClass = getRenewalClass(currentLang === 'en' ? (renewalDisplay === "Stopped" ? "Stopped" : renewalDisplay === "Waiting Renewal" ? "Waiting Renewal" : "Renewed") : (renewalDisplay === "Ø¥ÙŠÙ‚Ø§Ù" ? "Ø¥ÙŠÙ‚Ø§Ù" : renewalDisplay === "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ¬Ø¯ÙŠØ¯" ? "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ¬Ø¯ÙŠØ¯" : "ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯"));
                
                let displayCode = row['Ø§Ù„ÙƒÙˆØ¯'];
                const fUrl = row['file_url'];
                if (fUrl && String(fUrl).startsWith('http')) {
                    displayCode = `<a href="${fUrl}" target="_blank" class="flex items-center gap-1.5 text-indigo-600 font-black hover:text-indigo-800 transition-colors interactive-icon" title="ÙØªØ­ Ø§Ù„Ù…Ù„Ù"><i data-lucide="paperclip" class="w-3.5 h-3.5"></i>${row['Ø§Ù„ÙƒÙˆØ¯']}</a>`;
                }

                const locHtml = (row['Ø§Ù„Ù…ÙˆÙ‚Ø¹'] && String(row['Ø§Ù„Ù…ÙˆÙ‚Ø¹']).startsWith('http')) ? `<a href="${row['Ø§Ù„Ù…ÙˆÙ‚Ø¹']}" target="_blank" class="w-8 h-8 flex items-center justify-center rounded-full bg-emerald-50 text-emerald-600 hover:bg-emerald-500 hover:text-white transition-all mx-auto shadow-sm interactive-icon"><i data-lucide="map-pin" class="w-4 h-4"></i></a>` : '-';
                
                let statusBadgeClass = row.status === 'Ø³Ø§Ø±ÙŠØ©' ? 'badge-active' : row.status === 'Ù…Ù†ØªÙ‡ÙŠØ©' ? 'badge-expired' : 'badge-warning';

                return `
                <tr class="group animate-enter" style="animation-delay: ${index * 0.03}s">
                    <td class="w-check text-center desktop-only rounded-r-xl"><input type="checkbox" class="row-checkbox custom-checkbox cursor-pointer" value="${row['Ø§Ù„Ø±Ù‚Ù…']}" onchange="checkRow(this)" ${selectedIds.has(String(row['Ø§Ù„Ø±Ù‚Ù…'])) ? 'checked' : ''}></td>
                    <td class="w-id desktop-only text-slate-400 group-hover:text-indigo-500 font-bold transition-colors">${row['Ø§Ù„Ø±Ù‚Ù…']}</td>
                    <td class="w-code text-right font-mono font-bold ltr:text-left">${displayCode}</td>
                    <td class="w-entity text-slate-700" title="${entity}">${entity}</td>
                    <td class="w-type text-slate-600 desktop-only" title="${type}">${type}</td>
                    <td class="w-desc text-slate-500" title="${desc}">${desc || '-'}</td>
                    <td class="w-loc text-center">${locHtml}</td>
                    <td class="w-dur text-center font-bold text-slate-600 desktop-only"><span class="bg-slate-100/80 px-2 py-1 rounded-lg">${row['Ù…Ø¯Ø© Ø§Ù„Ø±Ø®ØµØ©']}</span></td>
                    <td class="w-date desktop-only">${formatDisplayDate(row['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡'])}</td>
                    <td class="w-date desktop-only">${formatDisplayDate(row['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡'])}</td>
                    <td class="w-stat-num font-black desktop-only ${row.diff < 0 ? 'text-rose-600' : 'text-emerald-600'}">${row.diff}</td>
                    <td class="w-stat-badge desktop-only"><span class="status-badge ${statusBadgeClass}">${statusTxt}</span></td>
                    <td class="w-renew text-center desktop-only"><span class="text-[10px] font-black ${renewalClass}">${renewalDisplay}</span></td>
                    <td class="w-act text-center action-cell rounded-l-xl">
                        <button onclick="toggleMenu('${row['Ø§Ù„Ø±Ù‚Ù…']}')" class="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-all settings-gear"><i data-lucide="settings-2" class="w-4.5 h-4.5"></i></button>
                        <div id="menu-${row['Ø§Ù„Ø±Ù‚Ù…']}" class="action-menu">
                            <div onclick="editLicense('${row['Ø§Ù„Ø±Ù‚Ù…']}')" class="action-item"><i data-lucide="edit-3" class="w-4 h-4"></i> ${uiTranslations[currentLang].menuEdit}</div>
                            <div onclick="duplicateLicense('${row['Ø§Ù„Ø±Ù‚Ù…']}')" class="action-item"><i data-lucide="copy" class="w-4 h-4"></i> ${uiTranslations[currentLang].menuDup}</div>
                            <div onclick="deleteSingle('${row['Ø§Ù„Ø±Ù‚Ù…']}')" class="action-item delete"><i data-lucide="trash-2" class="w-4 h-4"></i> ${uiTranslations[currentLang].menuDel}</div>
                        </div>
                    </td>
                </tr>`;
            }).join('');
            lucide.createIcons();
            renderCharts(processed);
            document.getElementById('tableFooter').innerHTML = `<span class="bg-indigo-50 text-indigo-600 px-2 py-1 rounded-lg">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${filtered.length}</span>`;
        }

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) { window.requestAnimationFrame(step); }
            };
            window.requestAnimationFrame(step);
        }

        function renderCharts(data) { 
            const ctxE = document.getElementById('entityChart').getContext('2d'); 
            if (entityChartInstance) entityChartInstance.destroy(); 
            const counts = {}; 
            data.forEach(d => { let n = translateText(currentLang === 'en' ? (d.entity_en || d['Ø§Ù„Ø¬Ù‡Ø©']) : d['Ø§Ù„Ø¬Ù‡Ø©']); counts[n] = (counts[n] || 0) + 1; }); 
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 10); 
            entityChartInstance = new Chart(ctxE, { 
                type: 'bar', 
                data: { labels: sorted.map(e => e[0]), datasets: [{ label: '', data: sorted.map(e => e[1]), backgroundColor: '#6366f1', borderRadius: 4, barPercentage: 0.3, hoverBackgroundColor: '#8b5cf6' }] }, 
                options: { 
                    responsive: true, maintainAspectRatio: false, indexAxis: 'x', 
                    plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', titleFont: { family: 'Tajawal' }, bodyFont: { family: 'Tajawal' } } },
                    scales: { y: { grid: { display: false, drawBorder: false }, ticks: { font: { family: 'Tajawal' } } }, x: { grid: { display: false }, ticks: { font: { family: 'Tajawal', weight: 'bold' } } } }
                } 
            }); 

            const ctxS = document.getElementById('statusChart').getContext('2d'); 
            if (statusChartInstance) statusChartInstance.destroy(); 
            const sCounts = [data.filter(d => d.status === "Ø³Ø§Ø±ÙŠØ©").length, data.filter(d => d.status === "Ù…Ù†ØªÙ‡ÙŠØ©").length, data.filter(d => d.status === "Ø´Ø§Ø±ÙØª Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡").length]; 
            statusChartInstance = new Chart(ctxS, { 
                type: 'doughnut', 
                data: { labels: ["Active", "Expired", "Warning"], datasets: [{ data: sCounts, backgroundColor: ['#10b981', '#f43f5e', '#f59e0b'], borderWidth: 2, borderColor: '#ffffff', hoverOffset: 10 }] }, 
                options: { 
                    responsive: true, maintainAspectRatio: false, cutout: '50%', // 3. ØªØ¹Ø¯ÙŠÙ„ Ø³Ù…Ùƒ Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± (cutout) Ù…Ù† 80% Ø¥Ù„Ù‰ 50% Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ù…Ùƒ
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            labels: { 
                                usePointStyle: true, boxWidth: 10, padding: 20, font: { family: 'Tajawal', weight: 'bold' },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map(function(label, i) {
                                            const meta = chart.getDatasetMeta(0);
                                            const style = meta.controller.getStyle(i);
                                            const value = data.datasets[0].data[i];
                                            return {
                                                text: label + ': ' + value,
                                                fillStyle: style.backgroundColor,
                                                strokeStyle: style.borderColor,
                                                lineWidth: style.borderWidth,
                                                hidden: isNaN(data.datasets[0].data[i]) || meta.data[i].hidden,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            } 
                        } 
                    } 
                } 
            }); 
        }

        function renderKPIs(data) { 
            const total = data;
            const active = data.filter(d => d.status === "Ø³Ø§Ø±ÙŠØ©");
            const warning = data.filter(d => d.status === "Ø´Ø§Ø±ÙØª Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡");
            const expired = data.filter(d => d.status === "Ù…Ù†ØªÙ‡ÙŠØ©");
            const kpis = [
                { title: uiTranslations[currentLang].kpiTotal, value: total.length, class: "kpi-blue", icon: "layers", list: total }, 
                { title: uiTranslations[currentLang].kpiActive, value: active.length, class: "kpi-green", icon: "check-circle-2", list: active }, 
                { title: uiTranslations[currentLang].kpiWarning, value: warning.length, class: "kpi-amber", icon: "alert-triangle", list: warning }, 
                { title: uiTranslations[currentLang].kpiExpired, value: expired.length, class: "kpi-rose", icon: "x-octagon", list: expired }
            ]; 
            document.getElementById('kpi-container').innerHTML = kpis.map((k, i) => {
                const listHTML = k.list.length > 0 ? k.list.map(item => `<div class="kpi-list-item"><span class="code">${item['Ø§Ù„ÙƒÙˆØ¯']}</span></div>`).join('') : '<div class="p-4 text-center text-gray-400 text-xs">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
                return `
                <div class="kpi-card ${k.class} p-5 flex flex-col justify-between h-32 animate-enter" style="animation-delay: ${i * 0.1}s">
                    <div class="flex justify-between items-start">
                        <p class="text-[11px] font-black uppercase tracking-wider opacity-70">${k.title}</p>
                        <div class="icon-box p-2 rounded-xl bg-white/40 backdrop-blur-sm"><i data-lucide="${k.icon}" class="w-5 h-5"></i></div>
                    </div>
                    <div><h2 class="text-4xl font-black mt-2 tracking-tight count-up" data-val="${k.value}">0</h2></div>
                    <div class="kpi-list custom-scrollbar">
                        <div class="kpi-list-header"><span>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</span><span>Ø§Ù„Ø¹Ø¯Ø¯: ${k.value}</span></div>
                        <div class="kpi-list-content">${listHTML}</div>
                    </div>
                </div>`;
            }).join(''); 
            document.querySelectorAll('.count-up').forEach(el => { animateValue(el, 0, parseInt(el.getAttribute('data-val')), 1000); });
            lucide.createIcons(); 
        }

        function toggleLanguage() { currentLang = currentLang === 'ar' ? 'en' : 'ar'; document.body.dir = currentLang === 'ar' ? 'rtl' : 'ltr'; document.getElementById('langLabel').textContent = currentLang === 'ar' ? 'EN' : 'Ø¹Ø±Ø¨ÙŠ'; renderAll(); }
        function openModal() { document.getElementById('editIndex').value = "-1"; document.getElementById('licenseForm').reset(); document.getElementById('newEntityDiv').classList.add('hidden'); document.getElementById('newTypeDiv').classList.add('hidden'); document.getElementById('licenseModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('licenseModal').classList.add('hidden'); }
        function calcDuration() { 
            const s = document.getElementById('inputStart').value; 
            const e = document.getElementById('inputEnd').value; 
            const d1 = parseDateSafe(s); 
            const d2 = parseDateSafe(e); 
            if (d1 && d2) document.getElementById('inputDuration').value = Math.max(0, Math.ceil((d2 - d1) / 86400000)); 
        }
        function checkRow(cb) { if (cb.checked) selectedIds.add(cb.value); else selectedIds.delete(cb.value); updateBulkDeleteButton(); }
        function toggleSelectAll() { const ch = document.getElementById('selectAll').checked; document.querySelectorAll('.row-checkbox').forEach(cb => { cb.checked = ch; if (ch) selectedIds.add(cb.value); else selectedIds.delete(cb.value); }); updateBulkDeleteButton(); }
        function updateBulkDeleteButton() { const btn = document.getElementById('bulkDeleteBtn'); btn.classList.toggle('hidden', selectedIds.size === 0); }
        function duplicateLicense(id) { const item = licenseData.find(i => String(i['Ø§Ù„Ø±Ù‚Ù…']) === String(id)); if(!confirm('Duplicate?')) return; const newData = {...item, 'Ø§Ù„Ø±Ù‚Ù…': Date.now().toString().slice(-5)}; licenseData.push(newData); renderAll(); fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'duplicate', row: newData }) }).then(()=>showToast('ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­')); }
        function deleteSelected() { if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) { const ids = Array.from(selectedIds); licenseData = licenseData.filter(i => !selectedIds.has(String(i['Ø§Ù„Ø±Ù‚Ù…']))); renderAll(); fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'delete_multi', ids: ids }) }).then(()=>showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­')); selectedIds.clear(); updateBulkDeleteButton(); } }
        function deleteSingle(id) { if(!confirm(uiTranslations[currentLang].msgConfirmDelete || 'Ø­Ø°ÙØŸ')) return; licenseData = licenseData.filter(i => String(i['Ø§Ù„Ø±Ù‚Ù…']) !== String(id)); renderAll(); fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id }) }).then(()=>showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­')); }
        function populateDropdowns() { const eSel = document.getElementById('inputEntity'), tSel = document.getElementById('inputType'); const reset = (sel) => { while(sel.options.length > 2) sel.remove(2); }; reset(eSel); reset(tSel); [...new Set(licenseData.map(i => i['Ø§Ù„Ø¬Ù‡Ø©']))].filter(Boolean).sort().forEach(e => eSel.add(new Option(e, e))); [...new Set(licenseData.map(i => i['Ù†ÙˆØ¹ Ø§Ù„Ø±Ø®ØµØ©']))].filter(Boolean).sort().forEach(t => tSel.add(new Option(t, t))); }
        function handleNewInput(sel, divId) { document.getElementById(divId).classList.toggle('hidden', sel.value !== 'ADD_NEW'); }
        function requestNotifyPermission() { if ("Notification" in window) Notification.requestPermission(); else alert("Not supported on this device"); }
        function checkDesktopNotifications() { 
            if ("Notification" in window && Notification.permission === "granted") { 
                const today = new Date();
                today.setHours(0,0,0,0);
                licenseData.forEach(i => { 
                    const d = parseDateSafe(i['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡']); 
                    if(d) {
                        const dObj = new Date(d);
                        dObj.setHours(0,0,0,0);
                        const diff = Math.round((dObj - today) / 86400000);
                        if (diff === 10 && i['renewal_status'] !== "ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯") {
                            new Notification("ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù†ØªÙ‡Ø§Ø¡", { body: `Ø±Ø®ØµØ© Ø±Ù‚Ù… ${i['Ø§Ù„Ø±Ù‚Ù…']} ØªÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ 10 Ø£ÙŠØ§Ù….` });
                        }
                    } 
                }); 
            } 
        }

        function editLicense(id) {
            const item = licenseData.find(i => String(i['Ø§Ù„Ø±Ù‚Ù…']) === String(id));
            if (!item) return;
            document.getElementById('editIndex').value = id;
            document.getElementById('inputNumber').value = item['Ø§Ù„Ø±Ù‚Ù…']; document.getElementById('inputCode').value = item['Ø§Ù„ÙƒÙˆØ¯'];
            const eSel = document.getElementById('inputEntity'); if(![...eSel.options].some(o => o.value === item['Ø§Ù„Ø¬Ù‡Ø©'])) eSel.add(new Option(item['Ø§Ù„Ø¬Ù‡Ø©'], item['Ø§Ù„Ø¬Ù‡Ø©'])); eSel.value = item['Ø§Ù„Ø¬Ù‡Ø©'];
            const tSel = document.getElementById('inputType'); if(![...tSel.options].some(o => o.value === item['Ù†ÙˆØ¹ Ø§Ù„Ø±Ø®ØµØ©'])) tSel.add(new Option(item['Ù†ÙˆØ¹ Ø§Ù„Ø±Ø®ØµØ©'], item['Ù†ÙˆØ¹ Ø§Ù„Ø±Ø®ØµØ©'])); tSel.value = item['Ù†ÙˆØ¹ Ø§Ù„Ø±Ø®ØµØ©'];
            document.getElementById('inputDesc').value = item.desc_ar || ""; 
            const dbStatus = item['renewal_status'];
            const renInput = document.getElementById('inputRenewal');
            if (dbStatus === 'Ø¥ÙŠÙ‚Ø§Ù' || dbStatus === 'Stopped') renInput.value = 'Ø¥ÙŠÙ‚Ø§Ù';
            else if (dbStatus === 'ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯' || dbStatus === 'Renewed') renInput.value = 'ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯';
            else renInput.value = 'ØªÙØ¹ÙŠÙ„';
            document.getElementById('existingFileUrl').value = item['file_url'] || "";
            document.getElementById('inputLocation').value = item['Ø§Ù„Ù…ÙˆÙ‚Ø¹']; 
            const dStart = parseDateSafe(item['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡']);
            const dEnd = parseDateSafe(item['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡']);
            if (dStart) document.getElementById('inputStart').value = toInputDate(dStart);
            if (dEnd) document.getElementById('inputEnd').value = toInputDate(dEnd);
            document.getElementById('inputNotes').value = item['Ù…Ù„Ø§Ø­Ø¸Ø§Øª']; calcDuration();
            document.getElementById('licenseModal').classList.remove('hidden');
        }

        function saveLicense() {
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.innerHTML = '<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...'; saveBtn.disabled = true;
            const id = document.getElementById('editIndex').value;
            const fileInput = document.getElementById('inputFile');
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result.split(',')[1];
                sendData(base64Data, file ? file.name : null, file ? file.type : null);
            };
            if (file) reader.readAsDataURL(file); else sendData(null, null, null);
        }

        function sendData(fileData, fileName, mimeType) {
            const id = document.getElementById('editIndex').value;
            const eSel = document.getElementById('inputEntity'), tSel = document.getElementById('inputType');
            const entity = eSel.value === 'ADD_NEW' ? document.getElementById('newEntityInput').value : eSel.value;
            const type = tSel.value === 'ADD_NEW' ? document.getElementById('newTypeInput').value : tSel.value;
            const renewalVal = document.getElementById('inputRenewal').value;
            const existingUrl = document.getElementById('existingFileUrl').value;
            const rowData = { 
                'Ø§Ù„Ø±Ù‚Ù…': document.getElementById('inputNumber').value, 
                'Ø§Ù„ÙƒÙˆØ¯': document.getElementById('inputCode').value, 
                'Ø§Ù„Ø¬Ù‡Ø©': entity, 'Ù†ÙˆØ¹ Ø§Ù„Ø±Ø®ØµØ©': type, 
                'Ø§Ù„Ø´Ø§Ø±Ø¹ â€“ Ø§Ù„ÙˆØµÙ': document.getElementById('inputDesc').value, 
                'Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¬Ø¯ÙŠØ¯': renewalVal, 
                'Ø§Ù„Ù…ÙˆÙ‚Ø¹': document.getElementById('inputLocation').value, 
                'Ù…Ø¯Ø© Ø§Ù„Ø±Ø®ØµØ©': document.getElementById('inputDuration').value, 
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡': document.getElementById('inputStart').value, 
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡': document.getElementById('inputEnd').value, 
                'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': document.getElementById('inputNotes').value,
                'file_url_old': existingUrl
            };
            const payload = { action: id === "-1" ? 'add' : 'update', originalId: id, row: rowData, fileData: fileData, fileName: fileName, mimeType: mimeType };
            fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(() => { 
                closeModal(); 
                document.getElementById('saveBtn').innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'; document.getElementById('saveBtn').disabled = false;
                showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
                fetchLicenses(); 
            })
            .catch(e => { showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', 'error'); document.getElementById('saveBtn').disabled = false; });
        }
        
        window.onload = fetchLicenses;
        document.getElementById('searchInput').oninput = renderAll;
        document.getElementById('statusFilter').onchange = renderAll;
    </script>
</body>

</html>
